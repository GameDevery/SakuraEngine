# SakuraEngine 任务系统

## 概述

SakuraEngine 的任务系统基于 Fiber（纤程）提供高性能的并行计算框架。系统默认使用 Google 的 marl 库作为后端，采用工作窃取调度策略，支持大规模并发任务执行。Fiber 比线程更轻量，允许在用户态进行上下文切换，特别适合游戏引擎中的细粒度并行任务。

## 核心概念

### Fiber 任务模型

Fiber 是比线程更轻量的执行单元：

- **用户态调度** - 避免系统调用开销
- **栈空间小** - 每个 Fiber 仅需几 KB 栈空间
- **快速切换** - 上下文切换成本极低
- **大规模并发** - 可创建数千个 Fiber

### 系统架构

```
┌─────────────────────────────────────────────────┐
│                Task System                       │
│  ┌──────────────────────────────────────────┐  │
│  │            Scheduler (marl)               │  │
│  │  ┌────────┐  ┌────────┐  ┌────────┐     │  │
│  │  │Worker 0│  │Worker 1│  │Worker N│     │  │
│  │  └────────┘  └────────┘  └────────┘     │  │
│  │       ↑           ↑           ↑          │  │
│  │       └───────────┴───────────┘          │  │
│  │           Work Stealing Queue             │  │
│  └──────────────────────────────────────────┘  │
│                                                 │
│  ┌──────────────────────────────────────────┐  │
│  │         Synchronization Primitives        │  │
│  │    counter_t    event_t    weak refs     │  │
│  └──────────────────────────────────────────┘  │
└─────────────────────────────────────────────────┘
```


## 总结

SakuraEngine 的 Fiber 任务系统提供了轻量级、高性能的并行计算框架。通过基于 marl 的工作窃取调度器和丰富的同步原语，系统能够高效处理游戏引擎中的各种并行任务。合理使用 parallel_for、concurrent 等并行模式，配合适当的批大小和同步策略，可以充分发挥多核 CPU 的计算能力。